# @funbox/crafter

## Мотивация

В нашей компании разрабатывается большое количество JSON API. Их необходимо
описывать и согласовывать, отслеживать изменения и показывать документацию
большому кругу лиц, поэтому возникла необходимость в удобном формате и средствах для
работы с документацией. Исторически в компании происходил выбор между
[API Blueprint](https://apiblueprint.org/) и [Swagger](https://swagger.io/). Мы
выбрали API Blueprint по двум причинам. Во-первых, исходный код документации,
описанной с помощью API Blueprint, проще воспринимается человеком. Во-вторых, на
момент исследования в Swagger не хватало ряда важных возможностей, например One
Of.

API Blueprint состоит из двух частей:

- парсера формата APIB [Drafter](https://github.com/apiaryio/drafter);
- рендерера HTML-версии документации
  [aglio](https://github.com/danielgtaylor/aglio).

Drafter — это библиотека, которая получает на вход текст в формате APIB и
возвращает распарсенное дерево в формате
[API Elements](http://api-elements.readthedocs.io/en/latest/) в виде YAML/JSON.
Drafter реализован на языке программирования C++. Код библиотеки достаточно
сложный и грязный, содержит много багов и легаси. Разобраться, как работает тот
или иной блок, очень сложно. Если исправление багов разработчики принимают
охотно, то при попытке добавить новую фичу можно сильно забуксовать и потратить
очень много времени на обсуждение, а в итоге фичу так и не примут. В нашей
компании практически нет проектов на C++, поэтому разработчиков, которые могут
поддерживать Drafter, очень мало, при этом необходимость в новых фичах возникает
регулярно.

## Описание

Библиотека **Crafter** — это замена Drafter, написанная на JavaScript, благодаря
чему ее легче поддерживать. Библиотека устраняет описанные выше недостатки
оригинала и реализует все необходимые возможности:

- Resource Prototypes — возможность задать общие ответы для разных ресурсов в
  одном месте и переиспользовать их во всей документации.
- Подключение внешних APIB-файлов, чтобы документация была модульной и более
  простой в использовании.
- Отключение fixed-type для массивов. В API Blueprint исторически сложилось, что
  описание типа как `array[SomeType]` означает, что в массиве могут быть
  элементы типа `SomeType`, а могут и не быть. Удобнее, если такое описание
  значило бы, что в массиве должны быть только элементы типа `SomeType`.
- Возможность использовать массивы в GET-параметрах.
- Описание некоторых типов данных напрямую в JSON Schema.
- Валидации длины строки и соответствия регулярному выражению.

Более подробную информацию о работе библиотеки можно найти в документах из
[docs](docs).

## Установка

Глобально:

```bash
npm install -g @funbox/crafter
```

Локально в проект:

```bash
npm install --save @funbox/crafter
```

## Использование

```javascript
const crafter = require('@funbox/crafter');
const ast = await Crafter.parseFile(file).toRefract();
```

Для парсинга из файла документации `doc.apib` требуется выполнить следующую
команду:

```bash
crafter [options] doc.apib
```

Доступные команды можно посмотреть через `crafter -h`.

## Запуск тестов

```bash
npm test
```

## Использование через Docker

Для использования @funbox/crafter в Docker-контейнере нужно выполнить следующую
команду в директории с вашей APIB-документацией:

```bash
docker run \
  --rm \
  -v $(pwd):/app \
  funbox/crafter -f json файл-с-документацией.apib
```

При запуске контейнера необходимо примонтировать хост-директорию с документацией
в некоторую директорию в контейнере и затем указать путь к APIB-файлу
относительно созданного в контейнере пути.

По умолчанию рабочей директорией образа задана директория `/app`, поэтому
удобнее всего смонтировать хост-директорию непосредственно в `/app`. Тогда в
качестве параметра можно передать просто название файла
`файл-с-документацией.apib`.

### Использование Docker-контейнера в Windows

При запуске контейнера в Windows нужно добавлять слеш (`/`) перед вызовом `pwd`.
Команда будет выглядеть так:

```bash
docker run \
  --rm \
  -v /$(pwd):/app/doc \
  funbox/crafter -f json doc/файл-с-документацией.apib
```

Кроме того, примонтированная директория может быть пустой. Если это так,
необходимо убедиться, что в настройках Docker Desktop for Windows, в разделе
Shared Drives включен шаринг нужного диска (стоит галка). Если диск не расшарен,
необходимо отметить его как `shared`, применить изменения и перезапустить Docker
Desktop.

